#!/bin/bash

# Sourceable functions for managing chains
# Usage: source chain-functions.env
#        chain [ethereum|gnosis]

# This script must be SOURCED, not executed
if [ "$0" = "$BASH_SOURCE" ]; then
    echo "Error: This script should be sourced, not executed"
    echo "Usage: source $0"
    exit 1
fi

DISPUTES_SYMLINK="./disputes.json"
ETHEREUM_FILE="./disputes-ethereum.json"
GNOSIS_FILE="./disputes-gnosis.json"
ETHEREUM_DIR="./ethereum"
GNOSIS_DIR="./gnosis"

# Function to show current chain
_chain_show_current() {
    if [ ! -L "$DISPUTES_SYMLINK" ]; then
        echo "Error: disputes.json is not a symlink"
        return 1
    fi
    
    local target=$(readlink "$DISPUTES_SYMLINK")
    local basename=$(basename "$target")
    
    case "$basename" in
        disputes-ethereum.json)
            echo "Current chain: ethereum"
            ;;
        disputes-gnosis.json)
            echo "Current chain: gnosis"
            ;;
        *)
            echo "Current chain: unknown ($basename)"
            ;;
    esac
}

# Function to show status of all chains
_chain_show_status() {
    echo "Chain Status:"
    echo ""
    
    # Current chain
    _chain_show_current
    echo ""
    
    # Ethereum
    if [ -f "$ETHEREUM_FILE" ]; then
        local count=$(jq '.data.disputes | length' "$ETHEREUM_FILE" 2>/dev/null)
        local max_id=$(jq '[.data.disputes[].id | tonumber] | max' "$ETHEREUM_FILE" 2>/dev/null)
        echo "Ethereum:"
        echo "  File: disputes-ethereum.json"
        echo "  Disputes: $count (max ID: $max_id)"
        if [ -d "$ETHEREUM_DIR" ]; then
            local folder_count=$(find "$ETHEREUM_DIR" -maxdepth 1 -type d -name "0x*" 2>/dev/null | wc -l | tr -d ' ')
            echo "  Folders: $folder_count in ethereum/"
        fi
    else
        echo "Ethereum: not configured"
    fi
    echo ""
    
    # Gnosis
    if [ -f "$GNOSIS_FILE" ]; then
        local count=$(jq '.data.disputes | length' "$GNOSIS_FILE" 2>/dev/null)
        local max_id=$(jq '[.data.disputes[].id | tonumber] | max' "$GNOSIS_FILE" 2>/dev/null)
        echo "Gnosis:"
        echo "  File: disputes-gnosis.json"
        echo "  Disputes: $count (max ID: $max_id)"
        if [ -d "$GNOSIS_DIR" ]; then
            local folder_count=$(find "$GNOSIS_DIR" -maxdepth 1 -type d -name "0x*" 2>/dev/null | wc -l | tr -d ' ')
            echo "  Folders: $folder_count in gnosis/"
        fi
    else
        echo "Gnosis: not configured"
    fi
    echo ""
    
    # Unorganized folders
    local unorganized=0
    for dir in 0x*; do
        if [ -d "$dir" ] && [ "$dir" != "0x*" ]; then
            unorganized=$((unorganized + 1))
        fi
    done
    if [ $unorganized -gt 0 ]; then
        echo "⚠️  Unorganized: $unorganized folder(s) in current directory"
    else
        echo "✓ No unorganized folders"
    fi
}

# Function to switch chain
_chain_switch() {
    local target_chain=$1
    local target_file=""
    
    case "$target_chain" in
        ethereum)
            target_file="$ETHEREUM_FILE"
            ;;
        gnosis)
            target_file="$GNOSIS_FILE"
            ;;
        *)
            echo "Error: Unknown chain '$target_chain'"
            echo "Available chains: ethereum, gnosis"
            return 1
            ;;
    esac
    
    if [ ! -f "$target_file" ]; then
        echo "Error: $target_file does not exist"
        return 1
    fi
    
    # Remove existing symlink
    if [ -L "$DISPUTES_SYMLINK" ] || [ -e "$DISPUTES_SYMLINK" ]; then
        rm "$DISPUTES_SYMLINK"
    fi
    
    # Create new symlink
    ln -s "$(basename "$target_file")" "$DISPUTES_SYMLINK"
    
    echo "✓ Switched to $target_chain"
    
    # Show stats
    local count=$(jq '.data.disputes | length' "$target_file" 2>/dev/null)
    local max_id=$(jq '[.data.disputes[].id | tonumber] | max' "$target_file" 2>/dev/null)
    if [ ! -z "$count" ] && [ "$count" != "null" ]; then
        echo "  Disputes: $count (max ID: $max_id)"
    fi
}

# Main chain function
chain() {
    local target_chain=$1
    
    if [ -z "$target_chain" ]; then
        # Show full status if no argument
        _chain_show_status
        return 0
    fi
    
    # Validate chain
    case "$target_chain" in
        ethereum|gnosis)
            ;;
        *)
            echo "Error: Unknown chain '$target_chain'"
            echo "Available chains: ethereum, gnosis"
            return 1
            ;;
    esac
    
    # Switch the symlink
    _chain_switch "$target_chain" || return 1
    
    # Source the environment file to update variables
    if [ -f "./chain-env.sh" ]; then
        echo ""
        echo "Loading environment variables..."
        source ./chain-env.sh "$target_chain"
    else
        echo ""
        echo "⚠️  Warning: chain-env.sh not found"
        echo "   Create it from template: cp chain-env.template.sh chain-env.sh"
        return 1
    fi
}

# Auto-completion (if in bash)
if [ -n "$BASH_VERSION" ]; then
    _chain_completion() {
        local cur="${COMP_WORDS[COMP_CWORD]}"
        COMPREPLY=( $(compgen -W "ethereum gnosis" -- "$cur") )
    }
    complete -F _chain_completion chain
fi

echo "Chain management functions loaded:"
echo "  chain                   - Show status of all chains"
echo "  chain <ethereum|gnosis> - Switch chain and load env vars"
echo ""
echo "Examples:"
echo "  chain"
echo "  chain ethereum"
echo "  chain gnosis"

